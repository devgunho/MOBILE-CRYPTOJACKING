<!DOCTYPE HTML>
<html  dir="">
	<head>
		<meta charset="utf-8">

		<title>steve &mdash; Chargen.One</title>
		
		<link rel="stylesheet" type="text/css" href="/css/write.css" />
		<link rel="shortcut icon" href="/favicon.ico" />
		<link rel="canonical" href="https://chargen.one/steve/">
		
		
		<link rel="alternate" type="application/rss+xml" title="steve &raquo; Feed" href="https://chargen.one/steve/feed/" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<meta name="generator" content="Write Freely">
		<meta name="description" content="Notes from underground">
		<meta itemprop="name" content="steve">
		<meta itemprop="description" content="Notes from underground">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:title" content="steve">
		<meta name="twitter:image" content="https://chargen.one/img/avatars/s.png">
		<meta name="twitter:description" content="Notes from underground">
		<meta property="og:title" content="steve" />
		<meta property="og:site_name" content="steve" />
		<meta property="og:type" content="article" />
		<meta property="og:url" content="https://chargen.one/steve/" />
		<meta property="og:description" content="Notes from underground" />
		<meta property="og:image" content="https://chargen.one/img/avatars/s.png">
		

		

		
		
<script>
  
  addEventListener('DOMContentLoaded', function () {
    var hlbaseUri = "/js/";
    var lb = document.querySelectorAll("code[class^='language-']");

    
    var langs = [];

    
    function highlight(nodes) {
      for (i=0; i < nodes.length; i++) {
          hljs.highlightBlock(nodes[i]);
      }
    }

    
    function loadLanguages(uris, callback) {
      uris.forEach(function(uri) {
        var sc = document.createElement('script');
        sc.src = uri;
        sc.async = false; 
        if (uris.indexOf(uri) == uris.length-1) {
          sc.onload = callback;
        }
        document.head.appendChild(sc);
      });
    }

    
    if (lb.length > 0) {
      
      var st = document.createElement('link');
      st.rel = "stylesheet";
      st.href = "/css/lib/atom-one-light.min.css";
      document.head.appendChild(st);

      
      var jss = [hlbaseUri + "highlight.min.js"];
      
      for (i=0; i < lb.length; i++) {
        lang = lb[i].className.replace('language-','');
        lurl = hlbaseUri + "highlightjs/" + lang + ".min.js";
        if (!(langs.includes(lang) || jss.includes(lurl))) {
          jss.push(lurl);
        }
      }
      
      loadLanguages(jss, () => {highlight(lb)});
    }
  });
</script>


	</head>
	<body id="collection" itemscope itemtype="http://schema.org/WebPage">
		
		
		<header>
		<h1 dir="" id="blog-title"><a href="/steve/" class="h-card p-author u-url" rel="me author">steve</a></h1>
		<p class="description p-note">Notes from underground</p>
		
		<nav>
			</nav>
		
		</header>
		
		<section id="wrapper" itemscope itemtype="http://schema.org/Blog">

			

			
<article id="post-hwuhmol4i3" class="sans h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h2 class="post-title" itemprop="name" class="p-name"><a href="/steve/do-not-disturb-how-i-tackled-my-own-smartphone-addiction" itemprop="url" class="u-url">Do Not Disturb: Tackling My Smartphone Addiction</a>
		
	</h2>
	<time class="dt-published" datetime="2019-03-09 13:50:31 &#43;0100 CET" pubdate itemprop="datePublished" content="2019-03-09 13:50:31 &#43;0100 CET">March 9, 2019</time>


<div lang="en" dir="auto" class="book e-content"><p><img src="https://www.haxors.club/dnd.jpg" alt="Smartphone manipulation"></p>

<p>Smartphones and Social Media are <a href="https://www.independent.co.uk/life-style/smartphones-ruin-life-ways-sleep-dating-sex-social-media-whatsapp-messaging-a7882031.html" rel="nofollow">ruining our lives</a>, say the press. It&#39;s not smartphones or social media itself. It&#39;s that we&#39;re biologically unprepared for how to deal with them. Smartphones and Social Media are designed to <a href="https://neurohacker.com/how-social-media-and-ai-hijack-your-brain" rel="nofollow">hijack</a> the attention and reward centres of the brain. They do it so well we don&#39;t notice how our brains are being altered.</p>

<p>In this post I write about how I changed my Smartphone use, and how this helped me reclaim my time and my attention span. It&#39;s about my ability to be present in the moment. Something I lost, then regained.</p>

<p>I won&#39;t talk about everything I do. Instead, I&#39;ll focus on things <em>you</em> can do. There&#39;s no talk of compiling your own firmware, mainlining F-droid or micro-g here. That&#39;s for some other time.</p>

<p>Instead, this post is about what I did that you can do <em>without</em> changing your phone.</p>

<blockquote><p>I never felt more connected to friends through my phone, but so absent in their presence.</p></blockquote>

<h2 id="how-things-got-out-of-control">How Things Got Out Of Control</h2>

<p>A few years ago, I had an iPhone 6. It was the digital tool I used more than anything else. If you could think of a pointless app, it&#39;d be on there. When a notification came I&#39;d hear a noise. The screen would light up, and, in pavlovian style so would my neurons. My phone went to bed with me, it woke up with me, it went to work with me.</p>

<p><img src="https://www.haxors.club/frog.jpg" alt="The phone takes over our lives, like boiling a frog"></p>

<p>I started to find that I was getting less happy. I felt less able to concentrate. I never felt more connected to friends through my phone, but so absent in their presence. My attention span shrivelled. I couldn&#39;t watch whole films. Reading books was impossible. In pockets of free time I&#39;d check Facebook, Twitter, Instagram, Email ad nauseum. I&#39;ve missed buses and trains because I was so absorbed in something I don&#39;t even remember reading. I had forgotten boredom. There was no time for my mind to wander. I became an <em><a href="http://www.wussu.com/poems/agh.htm" rel="nofollow">angelheaded hipster</a>, burning for the ancient heavenly connection to the starry dynamo in the machinery of night.</em></p>

<blockquote><p>I lost the buzz of low-effort connection, but gained the ability to connect with purpose.</p></blockquote>

<h2 id="the-flashpoint">The Flashpoint</h2>

<p>When Apple pulled the plug on the headphone jack, I realised my time with Apple&#39;s products was over. I didn&#39;t want to jump from Apple&#39;s walled garden into Google&#39;s. Instead I tried to degoogle my life (which is definitely another post in itself).</p>

<p>In the process I found ways to make my phone work for me rather than against me. I found a whole new world of ethical social media. So far, I&#39;ve gained happiness, time and space for myself. I lost the buzz of low-effort connection, but gained the ability to connect with purpose.</p>

<p>I wanted a <em>sustainable</em> phone experience. This isn&#39;t a minimalist experience. This isn&#39;t a phone pared back to the basics. It&#39;s a phone experience that works for, not against me. Everyone&#39;s sustainable phone experience is different. It&#39;s a journey, not a goal. A journey I encourage readers to travel.</p>

<h2 id="stage-1-do-not-disturb">Stage 1: Do Not Disturb</h2>

<p><img src="https://www.haxors.club/rest.jpg" alt="I&#39;m not waking this pupper up, and neither is my phone"></p>

<p>The first thing I did was reduce the volume and timing of notifications I receive. One of the best features on both Android and iOS is Do Not Disturb. This isn&#39;t enough alone, but combined with sane rules makes the break between you and your phone.</p>

<p>Since the early days of Blackberry, people were chained to notifications. Notifications have many problems, the worst of which is the impact on sleep. Do Not Disturb helps you take back your sleep. It also lets you take back your time.</p>

<p>Here&#39;s how I use my Do Not Disturb settings:</p>
<ol><li>No calls, messages or notifications from 8pm â 10am</li>
<li>Notifications from Tusky, Signal QKSMS and calls on Saturday and Sunday daytime</li>
<li>Exceptions for specific contact groups over specific services</li></ol>

<p>Using contact groups to manage exceptions lets family and friends reach you in your own time. Calls also come through if someone calls 3 times in 5 minutes. This works on both iOS and Android.</p>

<h2 id="stage-2-notifications">Stage 2: Notifications</h2>

<p><img src="https://www.haxors.club/no.jpg" alt="Putting the no in No-tifications"></p>

<p>I also restrict notifications. I restrict which apps can send notifications. I restrict <em>when</em> apps can send notifications.</p>

<p>On my iPhone I used IHG&#39;s app to book hotels. The app used notifications to update me about bookings. It also advertised to me. Many apps use notifications for adverts. This doesn&#39;t happen on my current phone.</p>

<p>The only apps that can trigger notifications on my phone are:</p>
<ul><li>Tusky for Mastodon notifications</li>
<li>Mail notifications</li>
<li>Calendar notifications</li>
<li>Signal Messenger for messages</li>
<li>App update notifications from F-Droid and Yalp</li></ul>

<p>For everything else, I can check the app when I feel like it.</p>

<blockquote><p>Imagine caring what people you barely know are up to while the most amazing person in the world lies next to you.</p></blockquote>

<h2 id="stage-3-reduce-interaction">Stage 3: Reduce Interaction</h2>

<p><img src="https://www.haxors.club/interaction.jpg" alt="Oh god, no."></p>

<p>A major try to get social media to notify me by email. This increases the amount of steps needed to respond. I use a dedicated mail account for low-value mail such as notifications and sign-ups. I now respond to notifications on my own time, not when a light pops up.</p>

<p>If I have an email notification, the app will still show it as unread when I visit. I set aside time to use social networks. I try to <em>use them with purpose</em> instead of passively scrolling through every 15 minutes.</p>

<p>Marizel and I noticed we used our phones when we woke up, and used them in bed before sleeping. Imagine caring what people you barely know are up to while the most amazing person in the world lies next to you.</p>

<p>Our phones stay outside of the bedroom now. In fact we use no technology in the bedroom beyond a light and a radiator. The room is now only used for about 3 things, none of which need complex technology.</p>

<h2 id="stage-4-trimming-apps">Stage 4: Trimming Apps</h2>

<p>Wanna see my home screen?</p>

<p><img src="https://www.haxors.club/homescreen.png" alt="My home screen"></p>

<p>I deleted Facebook in light of it&#39;s continuous commitment to <a href="https://gizmodo.com/facebook-is-paying-teens-to-install-a-research-app-that-1832182370" rel="nofollow">violating privacy</a>. The <a href="https://en.wikipedia.org/wiki/Facebook%E2%80%93Cambridge_Analytica_data_scandal" rel="nofollow">Cambridge Analytica scandal</a> was the last straw for me. I understand that for many people that&#39;s not an option. For example, I&#39;m still a heavy twitter user but it often makes me sad. That&#39;s why I keep it off my home screen.</p>

<p>Reducing the amount of apps I have helped a lot. Most of the time, you don&#39;t need an app. I started by removing apps I hadn&#39;t used in 6 months. I removed apps that had functioning mobile sites and bookmarked them on my home screen. I switched to lighter non-official social media clients that didn&#39;t bug or track me.</p>

<p>There are alternatives that will help you get your time back. If you can&#39;t delete Facebook, remove the app from your phone. If that&#39;s too much, replace it with a dedicated browser app only used for Facebook. Set Facebook&#39;s mobile site as the home page in that browser. Bonus points if your dedicated browser app supports ad-blocking.</p>

<p>If you find social media makes you angry or upset, consider consider using it from your Laptop only. Laptops tend not to stay online, unlike phones and tablets. Using a laptop requires a conscious decision to engage instead of a passive default. You can still catch up with friends and family on Facebook, but need to make a little effort to do so. Friction is the best tool to control social media control use.</p>

<p>Setting up ad-blockers on a laptop is often easier than on a phone. Having said that, there are great apps like <a href="https://better.fyi/" rel="nofollow">Better</a> that are worth looking at. Android Firefox supports add-ons on mobile, such as <a href="https://en.wikipedia.org/wiki/UBlock_Origin" rel="nofollow">uBlock Origin</a>.</p>

<h2 id="stage-5-seasonal-cleaning">Stage 5: Seasonal Cleaning</h2>

<p><img src="https://www.haxors.club/clean.jpg" alt="It&#39;s a journey, not a destination"></p>

<p>To keep things light, I created a 3 month folder on my home screen. Every month I go through my installed apps. If I haven&#39;t used an app that month, it goes in the 3 month folder. This means the app is on my home screen but not taking up space.</p>

<p>If I use it, it comes out of the drawer and off my home screen. If I don&#39;t use the app in 3 months, I uninstall it. This keeps my phone light, quick and clean.</p>

<p>I&#39;m pretty brutal about my home screen. My wallpaper is black, I use dark mode where I can and I keep the screen brightness low. I have 11 icons on my home screen, along with two folders:</p>
<ul><li>The 3 months folder discussed earlier</li>
<li>A folder named âDon&#39;tâ.</li></ul>

<p>The <em>Don&#39;t</em> folder holds apps I want to use less. Don&#39;t doesn&#39;t mean, âDon&#39;t use thisâ. It means âDon&#39;t make this your default actionâ. In my Don&#39;t folder currently, I have the following apps:</p>
<ul><li>Red Reader</li>
<li>SimplyWall.st</li>
<li>Tusky</li></ul>

<p>Once I feel my relationship with an app is back on track, I take it out of don&#39;t and decide where to put it next. If it doesn&#39;t improve, I&#39;ll consider removing it. I don&#39;t have to remove it. I just have to make an active decision about that app&#39;s future.</p>

<p>As I mentioned, my wallpaper is black, but I&#39;ve found some <a href="https://phonebreakup.com/resources/lockscreendownloads" rel="nofollow">great options</a> for lockscreens.</p>

<h2 id="an-aside-kinder-gentler-social-media">An Aside: Kinder, Gentler Social Media</h2>

<p><img src="https://www.haxors.club/baby.jpg" alt="Ethical Social Media exists. You should try it"></p>

<p>You might&#39;ve wondered what Tusky and Mastodon are. Well, I used to use Facebook, Twitter and Instagram. I find that these apps would encourage me to vomit thoughts, argue with people or share things that upset me. I decided to find alternatives, and I&#39;m glad I did.</p>

<p>I use Mastodon as a much happier alternative to Twitter. Mastodon is a bit like a friendlier, happier twitter. It&#39;s not the same, but that&#39;s a good thing. Instead of Instagram I use Pixelfed but that&#39;s still new, so I&#39;m waiting for an Android app. For writing I use writefreely. You&#39;re using it now to read this.</p>

<p>These applications are all part of something called the <a href="https://newatlas.com/what-is-the-fediverse/56385/" rel="nofollow">Fediverse</a>. It&#39;s a non-commercial, open way of sharing with each other. Nobody&#39;s incentivised to get you to like or share. Likewise, nobody&#39;s incentivised to like or share your stuff. These spaces tend to be smaller and sometimes less active, but are way healthier.</p>

<p>Ethical social media is less invasive. It avoids the dopamine-feedback loop you get with commercial networks. People can still contact me via social networks on <a href="https://mastodon.social/@stevelord" rel="nofollow">Mastodon</a> and <a href="https://pixelfed.social/stevelord" rel="nofollow">Pixelfed</a>. Of course, there are plenty of options for email.</p>

<h2 id="stage-6-making-social-media-an-active-choice">Stage 6: Making Social Media an Active Choice</h2>

<p><img src="https://www.haxors.club/right.jpg" alt="There are no wrong answers, just take the time to choose"></p>

<p>I&#39;ve got rid of most of the more evil social media around, how do I reclaim my life? Well, I start by setting particular times to use social media. I check social media on my phone mostly at the start of the day, and about an hour before bed. The rest of the time it needs to be a conscious decision to use it on my laptop.</p>

<p>It takes time to reclaim your attention span. I&#39;ve found Kindles to be amazing devices for this. I just wish I could find a more open alternative that did what I wanted. I&#39;ve also found little things to reclaim my attention span.</p>

<p>Instead of using a phone when I get up, I try to make sure Marizel is the first thing I see. If I&#39;m up first I&#39;ll spend a few minutes watching her sleep. Sometimes I think about random things. Other times I just watch her. I find this helps me focus on what&#39;s important.</p>

<p>I usually make us coffee first thing in the morning and I&#39;ll look out of the kitchen window while the kettle boils. It&#39;s not an amazing view, but the phone stays in the living room. It gives me time every day for my mind to wander. It&#39;s only 5 minutes while I wake up, but it makes a real difference to my perspective.</p>

<h2 id="final-thoughts">Final Thoughts</h2>

<p>The biggest thing I&#39;ve had to accept is that this is a work in progress. Sometimes I&#39;m going to fail. I&#39;m going to get into arguments on twitter. I&#39;m going to spend too much time on an app for no good reason. There will be times when I&#39;m physically with people, but mentally absent. It&#39;s ok. What&#39;s important is that I recognise it, and try to stop it happening next time.</p>

<p>But in a life surrounded by bells and flashing lights I can find the time to be present with those I care about. That&#39;s worth more than all the likes and shares in the world.</p>
</div></article><article id="post-ns2lhvbtu2" class="sans h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h2 class="post-title" itemprop="name" class="p-name"><a href="/steve/adding-name-based-hosting-to-nginx-on-openbsd-with-acme-client" itemprop="url" class="u-url">Adding Name-based hosting To Nginx on OpenBSD with Acme-Client</a>
		
	</h2>
	<time class="dt-published" datetime="2019-02-09 16:16:25 &#43;0100 CET" pubdate itemprop="datePublished" content="2019-02-09 16:16:25 &#43;0100 CET">February 9, 2019</time>


<div lang="en" dir="auto" class="book e-content"><p>Now that my <a href="https://openbsd.amsterdam/" rel="nofollow">OpenBSD.Amsterdam</a> VPS is up and running, and I have <a href="https://chargen.one/steve/backups-on-chargen-one" rel="nofollow">working backups</a>, I thought I&#39;d migrate some static sites over to this host and free up another dedicated server I&#39;m using. Adding extra static HTML won&#39;t add to the VPS&#39; general load and won&#39;t introduce new risks to <a href="/steve/tag:Chargen" class="hashtag" rel="nofollow"><span>#</span><span class="p-category">Chargen</span></a>.One.</p>

<p>To do this, I need to implement name-based Virtual Hosting. I&#39;m going to show how this is done for one site, <a href="https://hackingforfoodbanks.org/" rel="nofollow">hackingforfoodbanks.org</a>, then build upon it for multiple hosts. Finally, I&#39;ll modularize elements of the configuration to make things more manageable, including HTTPS support.</p>

<p>To make Name-based virtual hosting work, it&#39;s necessary to update <strong>/etc/acme-client.conf</strong>, the DNS Records for the domain in question, and the nginx configuration.</p>

<h2 id="moving-dns">Moving DNS</h2>

<p>This is the simplest part of the job. It&#39;s simply a case of logging into a DNS provider, and pointing the relevant DNS records at the HTTP server. Log into the DNS provider or server, point the relevant &#39;A&#39; and/or &#39;CNAME&#39; records to the HTTP server&#39;s IP address, and be prepared to wait up to 24 hours.</p>

<p>Now DNS is out of the way, the next thing is to clean up the nginx config <a href="https://chargen.one/steve/building-chargen-one" rel="nofollow">from earlier</a>.</p>

<h2 id="segregating-the-nginx-config">Segregating the Nginx config</h2>

<p>The config as-is is fine for just hosting Chargen.One but could get a bit unwieldy if I move all of my static sites across. I created a subdirectory in <strong>/etc/nginx/</strong> called <strong>sites</strong>, into which I can add server blocks for each site I want to host. This splits the configuration up into more manageable per-site blocks.</p>

<p>Before adding a new host, I split out the default chargen.one site config into a new file, <strong>/etc/nginx/sites/default.conf</strong>. This is a copy of the main <strong>/etc/nginx/nginx.conf</strong> site with everything from the openings <code>server{</code> to closing <code>}</code> characters included. It looks like this:</p>

<pre><code>server {
	listen       80 default_server;
	listen       [::]:80 default_server;
	server_name  _;
	root         /var/www/htdocs/c1;
	
	include acme.conf;
	
	#access_log  logs/host.access.log  main;
	#error_page  404              /404.html;
	
	# redirect server error pages to the static page /50x.html
	error_page   500 502 503 504  /50x.html;
	location = /50x.html {
	    root  /var/www/htdocs/c1;
	}
	
	# For reading content
	location ~ ^/(css|img|js|fonts)/ {
	        root /var/www/htdocs/c1;
	        # Optionally cache these files in the browser:
	        # expires 12M;
	}

	
	location ~ ^/.well-known/(webfinger|nodeinfo|host-meta) {
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $remote_addr;
	    proxy_pass http://127.0.0.1:8080;
	    proxy_redirect off;
	}
	
	location ~ ^/(css|img|js|fonts)/ {
	    root /var/www/htdocs/c1;
	    # Optionally cache these files in the browser:
	    # expires 12M;
	}
		
	location /{
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $remote_addr;
	    proxy_pass http://127.0.0.1:8080;
	    proxy_redirect off;
	}
}

# HTTPS server
#
server {
	listen       443 default_server;
	server_name  _;
	root         /var/www/htdocs/c1;
	include /etc/nginx/acme.conf;
	
	ssl                  on;
	ssl_certificate      /etc/ssl/chargen.one.fullchain.pem;
	ssl_certificate_key  /etc/ssl/private/chargen.one.key;
	ssl_session_timeout  5m;
	ssl_session_cache    shared:SSL:1m;
	ssl_ciphers  HIGH:!aNULL:!MD5:!RC4;
	ssl_prefer_server_ciphers   on;
	
	location ~ ^/.well-known/(webfinger|nodeinfo|host-meta) {
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $remote_addr;
	    proxy_pass http://127.0.0.1:8080;
	    proxy_redirect off;
	}
		
	location ~ ^/(css|img|js|fonts)/ {
	    root /var/www/htdocs/c1;
	    # Optionally cache these files in the browser:
	    # expires 12M;
	}
		
	location / {
	    proxy_set_header Host $host;
	    proxy_set_header X-Real-IP $remote_addr;
	    proxy_set_header X-Forwarded-For $remote_addr;
	    proxy_pass http://127.0.0.1:8080;
	    proxy_redirect off;
	}
}
</code></pre>

<p>With that entire block removed from the main config, below the line <code>server_tokens off;</code>, there&#39;s just the following remaining in <strong>/etc/nginx/nginx.conf</strong>:</p>

<pre><code>include /etc/nginx/sites/*.conf;
</code></pre>

<p>If I want to disable a site, I change the file extension from <strong>.conf</strong> to <strong>.dis</strong> and restart nginx. That way I can easily see which sites are enabled and which sites aren&#39;t without having to mess with the <code>ln</code> command or symbolic links.</p>

<h2 id="adding-a-new-virtual-host">Adding a new virtual host</h2>

<p>The first host is the hardest, but onces up and running provides a template for any future hosts. I keep things fairly minimal, but adding support for PHP-based sites is as simple as copying from the default OpenBSD nginx config. The TLS config still points to the chargen.one certificate as only the certificate&#39;s associated hostnames change, not the filename.</p>

<pre><code>    server {
        listen       80;
        server_name  hackingforfoodbanks.org www.hackingforfoodbanks.org;
        root         /var/www/htdocs/hackingforfoodbanks;

        include /etc/nginx/acme.conf;
        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root  /var/www/htdocs/hackingforfoodbanks;
        }

        location / {
            try_files $uri $uri/ =404;
            # Optionally cache these files in the browser:
            # expires 12M;
        }

    }

    # HTTPS server
    #
    server {
        listen 443;
        server_name  hackingforfoodbanks.org www.hackingforfoodbanks.org;
        root         /var/www/htdocs/hackingforfoodbanks;
        include /etc/nginx/acme.conf;

        ssl                  on;
        ssl_certificate      /etc/ssl/chargen.one.fullchain.pem;
        ssl_certificate_key  /etc/ssl/private/chargen.one.key;

        ssl_session_timeout  5m;
        ssl_session_cache    shared:SSL:1m;

        ssl_ciphers  HIGH:!aNULL:!MD5:!RC4;
        ssl_prefer_server_ciphers   on;

	location / {
	    root /var/www/htdocs/hackingforfoodbanks;
	    # Optionally cache these files in the browser:
	    # expires 12M;
	}

}
</code></pre>

<p>The only major differences are the removal of <code>default_server</code> in the listen directives, the changes to <code>server_name</code> and <code>root</code> to point to the correct spot and the removal of all of the dynamic parts associated with Chargen.One. Check whether or not there are problems with the nginx config before restarting by using the following command:</p>

<pre><code>nginx -t -c /etc/nginx/nginx.conf
</code></pre>

<p>Providing the syntax is ok, restart nginx with <code>rcctl restart nginx</code> as root, or via <code>doas</code>.</p>

<h2 id="adding-domains-to-acme-client">Adding domains to acme-client</h2>

<p>The final part of the puzzle is to add LetsEncrypt support for the new domain. The easiest way to add domains to acme-client is through the <code>alternative names</code> feature. Here&#39;s what I&#39;ve added to <strong>/etc/acme-client.conf</strong> in order to support the <a href="https://hackingforfoodbanks.org/" rel="nofollow">hackingforfoodbanks.org</a> URL.</p>

<pre><code>alternative names { hackingforfoodbanks.org www.hackingforfoodbanks.org }
</code></pre>

<p>After adding that, and deleting the existing <strong>/etc/ssl/chargen.one.crt</strong> file, <code>acme-client</code> can be called to add the new domain.</p>

<pre><code>rm /etc/ssl/chargen.one.crt
acme-client -vFAD chargen.one
</code></pre>

<blockquote><p>Note that the alternative names for our new domains are under the chargen.one <code>domain</code> section. The <code>domain</code> section name is passed to <code>acme-client</code>, not the domain itself.</p></blockquote>

<p>With a fully functioning certificate and nginx setup, run <code>rcctl restart nginx</code> to finish things off, and test the new site in a browser.</p>

<h2 id="adding-https-redirects">Adding HTTPS redirects</h2>

<p>You might want to redirect some of your sites to HTTPS rather than serve a HTTP version of your site. While often touted as a panacea, this introduces a mix of advantages and drawbacks.</p>
<ul><li>The content being delivered will be wrapped in transport layer encryption, making it harder for someone eavesdropping to identify the content being transferred (confidentiality)</li>
<li>As the transfer is encrypted, it becomes hard to interfere with the content.</li>
<li>HTTPS relies on a routinely (temporarily) broken permission-based model, often abused by companies and nation states. Thus while it&#39;s useful, it shouldn&#39;t be relied on for bulletproof 100% security.</li>
<li>Currently support TLS versions used in HTTPS aren&#39;t supported by most browsers available for legacy Operating Systems such as Windows XP. This means your site may be inaccessible over Windows XP and older versions of Android.</li></ul>

<p>I&#39;m not saying don&#39;t use HTTPS for a static site. There is no harm in supporting both, especially for a static web site. Just consider the site&#39;s audience and make a reasoned, deliberate decision as to whether or not to support accessing your content over HTTP before proceeding.</p>

<p>This site is accessible over HTTP and HTTPS precisely so users of older systems can still access the content via the <a href="/read" rel="nofollow">reader</a>, but authenticated access only works over HTTPS, and no mixed content is loaded.</p>

<p>As people accessing <a href="https://hackingforfoodbanks.org/" rel="nofollow">hackingforfoodbanks.org</a> may not have access to current technology (e.g. foodbank users), I made a conscious decision to leave HTTP access open. For another site, <a href="https://rawhex.com/" rel="nofollow">rawhex.com</a>, there&#39;s less of a requirement to leave HTTP access open, so I&#39;ll redirect that to HTTPS.</p>

<p>It&#39;s always annoying when a doc doesn&#39;t show the whole config for something complicated, so here&#39;s the <strong>/etc/nginx/sites/rawhex.conf</strong> file in full:</p>

<pre><code>    server {
        listen       80;
        server_name  rawhex.com www.rawhex.com;
        return 301 https://$server_name$request_uri;

    }

    # HTTPS server
    #
    server {
        listen 443;
        server_name  rawhex.com www.rawhex.com;
        root         /var/www/htdocs/www.rawhex.com;
        include /etc/nginx/acme.conf;

        ssl                  on;
        ssl_certificate      /etc/ssl/chargen.one.fullchain.pem;
        ssl_certificate_key  /etc/ssl/private/chargen.one.key;

        ssl_session_timeout  5m;
        ssl_session_cache    shared:SSL:1m;

        ssl_ciphers  HIGH:!aNULL:!MD5:!RC4;
        ssl_prefer_server_ciphers   on;

        # add HSTS header to ensure we don&#39;t hit the redirect again
        add_header Strict-Transport-Security &#34;max-age=31536000; includeSubDomains&#34; always;


        location / {
            root /var/www/htdocs/www.rawhex.com;
            # Optionally cache these files in the browser:
            # expires 12M;
        }

}
</code></pre>

<p>The HTTP 301 redirect shrinks the rest of the block to almost nothing. The HSTS header is a way to ensure that once redirected, a browser will only make requests over HTTPS, even if the user clicks on a HTTP link. The end result is an A+ score from Qualys&#39; <a href="https://www.ssllabs.com/ssltest/analyze.html?d=rawhex.com" rel="nofollow">SSL Labs</a>. There are things that can be done to improve the score, but these come at the cost of compatibility with older browsers and Operating Systems such as Windows Vista and 7.</p>

<h2 id="modularizing-further">Modularizing further</h2>

<p>You might&#39;ve noticed in the above that I&#39;m repeating a lot of SSL settings. For HTTPS sites, it&#39;s best to keep things consistent. As such I&#39;ve moved my ssl settings (aside from HSTS) into a separate file, <strong>/etc/nginx/https.conf</strong>. This means I only have to change one file for all HTTPS site configs. The current version of my file looks like this:</p>

<pre><code>        ssl                  on;
        ssl_certificate      /etc/ssl/chargen.one.fullchain.pem;
        ssl_certificate_key  /etc/ssl/private/chargen.one.key;

        ssl_session_timeout  30m;
        ssl_session_cache    shared:SSL:2m;

        ssl_ciphers  HIGH:!aNULL:!MD5:!RC4;
        ssl_prefer_server_ciphers   on;
</code></pre>

<p>I set a higher SSL Session timeout and cache for performance purposes. People should be able to use a single SSL session to cover a full visit to and around the site. People rarely spend longer than 30 minutes there unless they leave a tab open, at which point I&#39;m happy to reinitialize.</p>

<blockquote><p>Please don&#39;t confuse SSL Sessions with HTTP or application sessions. They&#39;re different things. If in doubt, the defaults are probably fine.</p></blockquote>

<p>Now all I have to do is add <code>include /etc/nginx/https.conf;</code> below <code>include /etc/nginx/acme.conf;</code> to my sites, and any changes to ciphers or timeouts will be picked up systemwide with a single change.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Now that I can add static sites to the Chargen.One system, I&#39;ll migrate the rest of my content over. With a clean, modular nginx config, content is served speedily and thanks to OpenBSD, to a level of security I&#39;m comfortable with. I still need to find somewhere to move my git repos to, and I&#39;m not sure chargen.one is right for that, but <a href="https://www.romanzolotarev.com/stagit.html" rel="nofollow">roman</a> has a few ideas that I might borrow from.</p>
</div></article><article id="post-uie6q0mh6k" class="norm h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h2 class="post-title" itemprop="name" class="p-name"><a href="/steve/no-regrets" itemprop="url" class="u-url">No Regrets</a>
		
	</h2>
	<time class="dt-published" datetime="2019-02-07 16:46:24 &#43;0100 CET" pubdate itemprop="datePublished" content="2019-02-07 16:46:24 &#43;0100 CET">February 7, 2019</time>


<div lang="en" dir="auto" class="book e-content"><p>Sometimes I miss things on the Internet the first time round. I&#39;m not aware they were things until I stumble across them randomly some time later. A week ago I came across the writing of <a href="https://bronnieware.com/about-bronnie/" rel="nofollow">Bronnie Ware</a>, a pallative nurse in Australia who in 2009, documented the 5 most common regrets she encountered from the dying.</p>

<p>The regrets themselves weren&#39;t surprising. I&#39;ve encountered all of them at some point. What surprised me was that the ones I&#39;d encountered were the common ones. In her post, <a href="https://bronnieware.com/blog/regrets-of-the-dying/" rel="nofollow">the regrets of the dying</a>, Bonnie lists 5 regrets she commonly encountered from her patients:</p>
<ol><li>I wish Iâd had the courage to live a life true to myself, not the life others expected of me.</li>
<li>I wish I hadnât worked so hard.</li>
<li>I wish Iâd had the courage to express my feelings.</li>
<li>I wish I had stayed in touch with my friends.</li>
<li>I wish that I had let myself be happier.</li></ol>

<p>Bonnie went on to write a book about this, <a href="https://www.bookdepository.com/Top-Five-Regrets-Dying-Bronnie-Ware/9781401940652" rel="nofollow">The Top Five Regrets of the Dying â A Life Transformed by the Dearly Departing</a>. Her blog post touched a lot of people at the time, including YCombinator founder <a href="http://paulgraham.com/todo.html" rel="nofollow">Paul Graham</a>.</p>

<p>Graham viewed at these regrets as <em>errors</em>, in this case of omission. Not everyone has the opportunities Graham has had in life, and while I can understand his rationale, I&#39;m not sure I agree with it. I believe these regrets have an internal element, but rarely arise in a vacuum.</p>

<p>I looked for signs of these regrets in myself and those around me. I found examples everywhere amongst my neighbours, family and friends:</p>
<ol><li>The regret of the women who married the man who knocked them up because it was expected at the time.</li>
<li>The regret of the men who try so hard to provide for their children they never get to grow close to them.</li>
<li>The gay men and trans women who attempted suicide because they couldn&#39;t reconcile their identity with their devout cultural or religious beliefs.</li>
<li>The old man living alone in his house, slowly forgetting everything and everyone he knew.</li>
<li>The women who spend their lives looking after everyone else, barely, if ever making time for herself.</li></ol>

<p>I&#39;ve experienced all 5 forms of Bronnies&#39; regrets. Thankfully I&#39;ve always had the ability to do something about it. I don&#39;t pretend that others have that capability. In fact I doubt most people are aware of these regrets until long after they&#39;ve formed.</p>

<p>What I can do, is when I see this in others is be kind, be patient, encourage them to open up, and to listen. But I felt I should find a way to identify the first signs of these regrets in myself.</p>

<p>Graham inverted the regrets to create a list of 5 commands, but I found these to be very negative. Perhaps that&#39;s ok for him. It&#39;s not really for me. Instead, I chose 5 questions to periodically ask myself. Their purpose is to help me become more mindful of things that make me sad:</p>
<ol><li>Have I been authentic throughout the month, or was there a moment where I became a version of me to meet the expectations of others?</li>
<li>Have I made enough time and space this week to be with those I love?</li>
<li>This week, have I been continuously open and honest with myself and those around me?</li>
<li>When did I last talk about something other than work to those I really care for?</li>
<li>What did I do <em>for me</em> this week?</li></ol>

<p>I&#39;ve put these 5 questions up here, so I can check in on myself now and again. I also have them in a notes folder so I can go through the list once a week.</p>

<p>If the answer to a question is no, I make a note in Joplin about why the answer is no, and what I&#39;ll do to address it. It&#39;s ok for there to be a no response to a question, but I should at least make a conscious decision about it when it arises. There are no wrong answers, the thinking alone is often enough to kick me into gear.</p>

<p>My hope is that by asking these questions regularly, I can avoid things before they become regrets, instead of fixing them later on. That way, whenever it&#39;s time to die, I can do so with no regrets.</p>
</div></article><article id="post-0fops7d1fi" class="sans h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h2 class="post-title" itemprop="name" class="p-name"><a href="/steve/backups-on-chargen-one" itemprop="url" class="u-url">Pull-based Backups using OpenBSD base*</a>
		
	</h2>
	<time class="dt-published" datetime="2019-02-03 14:01:33 &#43;0100 CET" pubdate itemprop="datePublished" content="2019-02-03 14:01:33 &#43;0100 CET">February 3, 2019</time>


<div lang="en" dir="auto" class="book e-content"><blockquote><p>*The approach and scripts discussed here use <code>mysqldump</code> to back up a database at one point. Yes I know this isn&#39;t in OpenBSD base, but this was added just for a specific system. It&#39;s easy not to add it, and everything else is done through tools from the base system.</p></blockquote>

<p>With any system, it&#39;s important backups and restores work properly. With <a href="/steve/tag:Chargen" class="hashtag" rel="nofollow"><span>#</span><span class="p-category">Chargen</span></a>.One, I wanted to protect user data, and be able to easily restore. The important things for the backup were:</p>
<ul><li>Single timestamped backup file</li>
<li>No additional software installed above what&#39;s already on the box</li>
<li>Backups are pulled from a central server, not pushed to one</li>
<li>Portable script</li>
<li>Use privilege separation so local accounts can&#39;t access backups</li></ul>

<p>Most services like <a href="https://www.borgbackup.org/" rel="nofollow">borg backup</a> work best with a backup server visible from the server being backed up. I use a huge NAS to store my backups, and a separate server to store backups of backups. The NAS is behind a Firewall and the other server can see the NAS but not the Internet. As such, I need a backup system that lets me use the NAS to pull from Chargen.One onto the NAS, and then allow my isolated backup server to pull from the NAS. If that sounds a little paranoid, at least you understand why I use OpenBSD.</p>

<p>Backups are taken by root on a nightly basis, and put into a folder belonging to a dedicated backup user. Early in the morning, the backup is pulled from a system which deletes the backup from chargen.one. The remote backup system will store 30 days&#39; worth of backups.</p>

<h2 id="configuring-a-backup-account">Configuring a backup account</h2>

<p>The <strong>/home</strong> partition is the largest on the VPS, so I created an account to store backups in a temporary folder, create an archive, delete the temporary folder and change permissions so the remote backup system can pull and remove the backup archive.</p>

<p>To set up the backup user account, use the following commands (as root):</p>

<pre><code># useradd -m backup
# chmod 700 /home/backup
# su - backup
$ cd .ssh
</code></pre>

<p>On the backup system, generate an ssh keypair using <code>ssh-keygen -t ed25519</code>. Copy the contends of <strong>id_ed25519.pub</strong> from the backup system into <strong>/home/backup/.ssh/authorized_keys</strong> on the server being backed up.</p>

<p>SSH into the backup account on the server from the NAS to make sure everything works.</p>

<p>Each backup archive is created by a script that creates and stores content in <strong>/home/backup/backup/</strong>. Once backed up, the script will create a timestamped archive file and delete the <strong>/home/backup/backup/</strong> directory. The script starts off very simply:</p>

<pre><code>#!/bin/sh

mkdir /home/backup/backup
# Add stuff below here


# Don&#39;t add stuff below here
rm -rf /home/backup/backup
</code></pre>

<h2 id="backing-up-mysql-data">Backing up MySQL data</h2>

<blockquote><p>If you want to implement my backup scheme and don&#39;t run MariaDB or MySQL, then skip this section and backup using commands from base only.</p></blockquote>

<p>Because MySQL is configured to use passwords, a <strong>/root/.my.cnf</strong> file containing credentials for the mysqldump command is needed.</p>

<pre><code>[mysqldump]
user=root
password=your_password_here
</code></pre>

<p>The <code>mysqldump</code> command fully backs up all mysql databases, routines, events and triggers.</p>

<p>Add the following to the backup script (all one line):</p>

<pre><code>mysqldump -A -R -E --triggers --single-transaction  &gt; /home/backup/backup/mysql.gz
</code></pre>

<p>The <code>--single-transaction</code> option causes the backup to take place without locking tables.</p>

<h2 id="backing-up-a-package-list">Backing up a package list</h2>

<p>OpenBSD uses it&#39;s own package management system called pkg. To create a backup of installed packages add the following to the backup script:</p>

<pre><code>pkg_info -mz &gt; /home/backup/backup/packages.txt
</code></pre>

<p>This can then be restored from a backup using <code>pkg_add -l packages.txt</code>.</p>

<h2 id="backing-up-files">Backing up files</h2>

<p>The following files and directories should be backed up:</p>
<ul><li>/etc</li>
<li>/root</li>
<li>/var/www</li>
<li>/var/log</li>
<li>/var/cron</li>
<li>/home, excluding /home/backup</li>
<li>/usr/local/bin/writefreely</li>
<li>/usr/local/share/writefreely</li></ul>

<p>Use the <code>tar</code> command to create backups. A discussion of the tar command is best left to <code>man tar</code>, but as the backup isn&#39;t very large, I&#39;m not using incremental backups, which keeps things simple...up to a point.</p>

<p>OpenBSD&#39;s <code>tar</code> implementation doesn&#39;t add the <code>--exclude</code> option as it&#39;s a GNU extension. Other BSDs such as FreeBSD <em>do</em> add the option, but the OpenBSD team prefer not to have it. I could&#39;ve added the GNU tar package, but one of the stated goals of the script is to not require additional software to keep things portable. Paths such as /home/backup are excluded using shell expansion instead.</p>

<p>To test this, try the following command:</p>

<pre><code># tar cvf bk.tar /home/!(backup)
</code></pre>

<p>The exclamation mark means <em>exclude anything in the parentheses</em>. For multiple directories, separate the names with a pipe symbol, e.g. <code>!(backup|user)</code> to exclude both backup and user directories.</p>

<p>There are complications and error messages will be shown on each backup if absolute paths are added to the tar command. This means that an email would be generated every night, even if the backup succeeds. Ain&#39;t nobody got time for that.</p>

<p>As a workaround, changing to the root directory at the start makes all paths relative, and allows the shell expansion to work. The <code>-C</code> switch can be used instead, but this breaks shell expansion.</p>

<p>The final commands to go in the script look like this:</p>

<pre><code>cd /
tar cf /home/backup/backup/files.tar etc/!(spwd.db) root \
	var/www var/log home/!(backup) /var/cron \
	usr/local/bin/writefreely usr/local/bin/backup.sh \
	usr/local/share/writefreely 
</code></pre>

<p>I&#39;ve used backslashes to break up the lines for readability, but all the paths could be put on a single line if preferred.</p>

<p>I&#39;ve excluded <strong>/etc/spwd.db</strong> from the backup because OpenBSD&#39;s built-in tar uses a feature called pledge that restricts access to certain files. The file isn&#39;t particularly important to this specific backup, but contains the shadow password database, which I&#39;m happy to recreate as part of the restore process.</p>

<p>At this point you might wonder why <code>gzip</code> compression isn&#39;t being used in the tar archive. This is because the final archive will be compressed, and there&#39;s no point in compressing twice.</p>

<h2 id="creating-the-final-archive">Creating the final archive</h2>

<p>To distinguish between backups by date, I used a timestamp, generated by the <code>date</code> command. By default there are spaces and colons, neither of which are good for interoperability across Operating Systems and filesystems. Use <code>date +%F_%H%M%S</code> to generate a more reasonable format. Using <code>tar</code>&#39;s <code>-C</code> switch changes the <code>tar</code> working directory to /home/backup and stops a leading / error message appearing in the backup.</p>

<p>The final <code>tar</code> command in the backup script should look like this:</p>

<pre><code>tar zcf /home/backup/c1_$(date +%F_%H%M%S).tgz -C /home/backup backup
</code></pre>

<p>It&#39;s also important to change the file ownership to the backup user so the remote system can delete the backup after it&#39;s been created.</p>

<pre><code>chown backup:backup /home/backup/c1_*
</code></pre>

<p>The full backup script on chargen.one looks like this:</p>

<pre><code>#!/bin/sh

mkdir /home/backup/backup
# Add stuff below here

# MySQL Backup
mysqldump -u root -A -R -E --triggers --single-transaction | gzip -9 &gt; /home/backup/backup/mysql.gz

# Packages backup
pkg_info -mz &gt; /home/backup/backup/packages.txt

# Files backup
cd /
tar cf /home/backup/backup/files.tar etc/!(spwd.db) root \
	var/www var/log home/!(backup) /var/cron \
	usr/local/bin/writefreely usr/local/bin/backup.sh \
	usr/local/share/writefreely 

# Final archive
tar zcf /home/backup/c1_$(date +%F_%H%M%S).tgz \
	-C /home/backup backup

# Fix permissions
chown backup:backup /home/backup/c1_*

# Don&#39;t add stuff below here
rm -rf /home/backup/backup
</code></pre>

<h2 id="automating-the-backup">Automating the backup</h2>

<p>As root (via <code>su -</code>, not <code>doas</code>), use <code>crontab -e</code> and add the following entry:</p>

<pre><code>0 1 * * * /usr/local/bin/backup.sh
</code></pre>

<p>A new backup is created at 1am, every morning. On the remote server, a cron job calls a script at 3am to pull the backup down via <code>scp</code> using the following:</p>

<pre><code>#!/bin/sh

find /Backups/c1/ -mtime +30 -exec rm {} \;
scp -q backup@chargen.one:./c1_*.tgz /Backups/c1/
ssh backup@chargen.one rm c1_*.tgz
</code></pre>

<p>And that&#39;s it! The secondary backup server pulls down the contents of /Backups from the NAS, so there&#39;s nothing left to do.</p>

<p>I&#39;ll write a separate post about restoring, as this post is already getting long, but hopefully it&#39;s useful to people who want pull, rather than push backups.</p>
</div></article><article id="post-ui7xh7lpth" class="norm h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h2 class="post-title" itemprop="name" class="p-name"><a href="/steve/how-chargen-is-different" itemprop="url" class="u-url">How Chargen is different</a>
		
	</h2>
	<time class="dt-published" datetime="2019-02-02 17:14:44 &#43;0100 CET" pubdate itemprop="datePublished" content="2019-02-02 17:14:44 &#43;0100 CET">February 2, 2019</time>


<div lang="en" dir="auto" class="book e-content"><p>Chargen.one is a little different to most writing experiences. It&#39;s still, very <em>very</em> much in development, so things are in places where you might not ordinarily expect them to be, and some things aren&#39;t there at all.</p>

<p>I&#39;ve configured everything to support multiple blogs per user. As this is a themed instance, some people may want to have more than one blog. Your first blog uses your username by default, but each author can create up to 5.</p>

<p>For example, I&#39;m interested in personal finance and investing, but by putting any thoughts into a separate blog, I can spare my less interested readers the boredom that comes with such a thing.</p>

<p>You might also notice the lack of image upload function. This is deliberate. If you want to use images, I&#39;d suggest using something your own hosting or something like <a href="https://pixelfed.org" rel="nofollow">PixelFed</a>. It&#39;s all markdown here, and easy to export too.</p>

<p>When you first hit publish, instead of going to your blog the post goes to drafts. You can then move it to a blog. This prevents you from accidentally publishing something you don&#39;t. Your account is also private by default. It can be made public in the settings.</p>
</div></article><article id="post-q5elxrwe0k" class="sans h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	
	<h2 class="post-title" itemprop="name" class="p-name"><a href="/steve/building-chargen-one" itemprop="url" class="u-url">Building Chargen.One</a>
		
	</h2>
	<time class="dt-published" datetime="2019-02-02 16:45:26 &#43;0100 CET" pubdate itemprop="datePublished" content="2019-02-02 16:45:26 &#43;0100 CET">February 2, 2019</time>


<div lang="en" dir="auto" class="book e-content"><p>I&#39;ve written this in case anyone else wants to try and build their own instance of <a href="/steve/tag:Chargen" class="hashtag" rel="nofollow"><span>#</span><span class="p-category">Chargen</span></a>.One on OpenBSD. If you&#39;re looking for the easy route to getting Writefreely working, then docker is the way. This is the hard way, but as a federated blogging site with the *BSD community in mind, I felt it important that it runs on a BSD of some sort.</p>

<p>There are two systems involved in Chargen.One, a build system and a deployment system. There is actually a test environment but that&#39;s the same as the deployment environment. The build environment is called <em>c0</em>, the deployment is <em>c1</em>. Both run OpenBSD 6.4 at the time of writing.</p>

<p>This post covers setting up the initial webserver with nginx and letsencrypt. Part two will cover the mysql config, part 3 the build and part 4 my deployment process.</p>

<h2 id="initial-housekeeping">Initial housekeeping</h2>

<p>On the build system, start by following the process detailed in <code>man afterboot</code>.</p>

<p>I used an OpenBSD.Amsterdam VM for the deployment system, so there&#39;s some <a href="https://www.romanzolotarev.com/openbsd/oams.html" rel="nofollow">tweaks</a> to implement before you start.</p>

<h2 id="installing-nginx-and-lets-encrypt">Installing Nginx and Lets Encrypt</h2>

<p>On both c0 and c1 it&#39;s the same. As root, run <code>pkg_add nginx</code>. Update <strong>/etc/newsyslog.conf</strong> as per the info in <strong>/usr/local/share/doc/pkg-readmes/nginx</strong>.</p>

<h3 id="preparing-nginx-for-letsencrypt">Preparing Nginx for LetsEncrypt</h3>

<p>Add the line <code>include acme.conf;</code> to c1&#39;s port 80 server block below <code>root /var/www/htdocs;</code></p>

<p>Now create a <strong>/etc/nginx/acme.conf</strong> file with the following</p>

<pre><code>location ^~ /.well-known/acme-challenge {
    alias /var/www/acme;
    try_files $uri =404;
}
</code></pre>

<h3 id="preparing-letsencrypt">Preparing LetsEncrypt</h3>

<p>We&#39;ll configure C1 to use LetsEncrypt. All content will be served over HTTPS, with only the reader accessible over HTTP for older systems.</p>

<p>Create a domain entry at the bottom of <strong>/etc/acme-client.conf</strong> file like the following:</p>

<pre><code>domain chargen.one {
        domain key &#34;/etc/ssl/private/chargen.one.key&#34;
        domain certificate &#34;/etc/ssl/chargen.one.crt&#34;
        domain full chain certificate &#34;/etc/ssl/chargen.one.fullchain.pem&#34;
        sign with letsencrypt
}
</code></pre>

<h3 id="getting-certs-and-a-working-https-setup">Getting certs and a working HTTPS setup</h3>

<p>Restart nginx, run <code>acme-client -vAD</code> and you should have working certs. Now it&#39;s time to configure HTTPS. The commented out defaults are reasonably sane at the time of writing, just change things to point to your certs. Here&#39;s what I had set up. We&#39;ll change this later.</p>

<pre><code>    server {
        listen       443;
        server_name  chargen.one;
        root         /var/www/htdocs;

        ssl                  on;
        ssl_certificate      /etc/ssl/chargen.one.fullchain.pem;
        ssl_certificate_key  /etc/ssl/private/chargen.one.key;

        ssl_session_timeout  5m;
        ssl_session_cache    shared:SSL:1m;

        ssl_ciphers  HIGH:!aNULL:!MD5:!RC4;
        ssl_prefer_server_ciphers   on;
    }
</code></pre>
</div></article>


		

		</section>

		
		<footer>
			<hr />
			<nav dir="ltr">
				<a class="home pubd" href="/">Chargen.One</a> &middot; powered by <a style="margin-left:0" href="https://writefreely.org">write freely</a>
			</nav>
		</footer>
		
	</body>

	
	<script src="/js/h.js"></script>
	<script src="/js/postactions.js"></script>
	<script type="text/javascript">
var deleting = false;
function delPost(e, id, owned) {
	e.preventDefault();
	if (deleting) {
		return;
	}

	
	if (window.confirm('Are you sure you want to delete this post?')) {
		
		deletePost(id, "", function() {
			
			var $postEl = document.getElementById('post-' + id);
			$postEl.parentNode.removeChild($postEl);
			
		});
	}
}

var deletePost = function(postID, token, callback) {
	deleting = true;

	var $delBtn = document.getElementById('post-' + postID).getElementsByClassName('delete action')[0];
	$delBtn.innerHTML = '...';

	var http = new XMLHttpRequest();
	var url = "/api/posts/" + postID;
	http.open("DELETE", url, true);
	http.onreadystatechange = function() {
		if (http.readyState == 4) {
			deleting = false;
			if (http.status == 204) {
				callback();
			} else if (http.status == 409) {
				$delBtn.innerHTML = 'delete';
				alert("Post is synced to another account. Delete the post from that account instead.");
				
				
				
			} else {
				$delBtn.innerHTML = 'delete';
				alert("Failed to delete." + (http.status>=500?" Please try again.":""));
			}
		}
	}
	http.send();
};

var pinning = false;
function pinPost(e, postID, slug, title) {
	e.preventDefault();
	if (pinning) {
		return;
	}
	pinning = true;

	var callback = function() {
		
		var $postEl = document.getElementById('post-' + postID);
		$postEl.parentNode.removeChild($postEl);
		var $header = document.getElementsByTagName('header')[0];
		var $pinnedNavs = $header.getElementsByTagName('nav');
		
		var link = '<a class="pinned" href="/steve/'+slug+'">'+title+'</a>';
		if ($pinnedNavs.length == 0) {
			$header.insertAdjacentHTML("beforeend", '<nav>'+link+'</nav>');
		} else {
			$pinnedNavs[0].insertAdjacentHTML("beforeend", link);
		}
	};

	var $pinBtn = document.getElementById('post-' + postID).getElementsByClassName('pin action')[0];
	$pinBtn.innerHTML = '...';

	var http = new XMLHttpRequest();
	var url = "/api/collections/steve/pin";
	var params = [ { "id": postID } ];
	http.open("POST", url, true);
	http.setRequestHeader("Content-type", "application/json");
	http.onreadystatechange = function() {
		if (http.readyState == 4) {
			pinning = false;
			if (http.status == 200) {
				callback();
			} else if (http.status == 409) {
				$pinBtn.innerHTML = 'pin';
				alert("Post is synced to another account. Delete the post from that account instead.");
				
				
				
			} else {
				$pinBtn.innerHTML = 'pin';
				alert("Failed to pin." + (http.status>=500?" Please try again.":""));
			}
		}
	}
	http.send(JSON.stringify(params));
};

	try {
	  WebFontConfig = {
		custom: { families: [ 'Lora:400,700:latin', 'Open+Sans:400,700:latin' ], urls: [ '/css/fonts.css' ] }
	  };
	  (function() {
		var wf = document.createElement('script');
		wf.src = '/js/webfont.js';
		wf.type = 'text/javascript';
		wf.async = 'true';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(wf, s);
	  })();
	} catch (e) {}
	</script>
</html>


#####EOF#####


